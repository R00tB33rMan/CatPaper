From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: camdenorrb <me@12oclock.dev>
Date: Thu, 17 Nov 2022 02:00:52 -0600
Subject: [PATCH] Fix crash


diff --git a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
index 2da1b4a9f51c5c1606e55bb09b3090ff5e321038..4b969486060788d38aefe6bbc6b3da8f9bc4ff4f 100644
--- a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
+++ b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
@@ -25,6 +25,7 @@ import org.bukkit.entity.Player;
 import org.jetbrains.annotations.NotNull;
 
 import java.util.*;
+import java.util.concurrent.ConcurrentSkipListSet;
 import java.util.concurrent.CopyOnWriteArraySet;
 import java.util.concurrent.atomic.AtomicInteger;
 
@@ -109,7 +110,7 @@ public final class PlayerChunkLoader {
         return Integer.compare(System.identityHashCode(p1), System.identityHashCode(p2));
     });
 
-    protected final TreeSet<PlayerLoaderData> chunkSendWaitQueue = new TreeSet<>((final @NotNull PlayerLoaderData p1, final @NotNull PlayerLoaderData p2) -> {
+    protected final ConcurrentSkipListSet<PlayerLoaderData> chunkSendWaitQueue = new ConcurrentSkipListSet<>((final @NotNull PlayerLoaderData p1, final @NotNull PlayerLoaderData p2) -> {
         if (p1 == p2) {
             return 0;
         }
@@ -792,7 +793,7 @@ public final class PlayerChunkLoader {
         // warning: modifications of this field must be aware that the loadQueue inside PlayerChunkLoader uses this field
         // in a comparator!
         protected final ArrayDeque<ChunkPriorityHolder> loadQueue = new ArrayDeque<>();
-        protected final LongOpenHashSet sentChunks = new LongOpenHashSet();
+        protected final ConcurrentSkipListSet<Long> sentChunks = new ConcurrentSkipListSet<>();
         protected final LongOpenHashSet chunksToBeSent = new LongOpenHashSet();
 
         protected final TreeSet<ChunkPriorityHolder> sendQueue = new TreeSet<>((final @NotNull ChunkPriorityHolder p1, final @NotNull ChunkPriorityHolder p2) -> {
diff --git a/src/main/java/net/minecraft/world/entity/LivingEntity.java b/src/main/java/net/minecraft/world/entity/LivingEntity.java
index 471338dc1ea04f452437fe284fa7bb54fc3ec9fd..de6fcf6cae6a7a70bcad5f6f5567f2beb16bd40b 100644
--- a/src/main/java/net/minecraft/world/entity/LivingEntity.java
+++ b/src/main/java/net/minecraft/world/entity/LivingEntity.java
@@ -1944,7 +1944,7 @@ public abstract class LivingEntity extends Entity {
 
         if (i > 0) {
             // CraftBukkit start
-            if (!this.hurt(damageSource, null, null, (float) i)) {
+            if (!this.hurt(damageSource, damagerEntity, damagerBlock, (float) i)) {
                 return true;
             }
             // CraftBukkit end
